<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Private Notes Vault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      /* Custom styles */
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .note-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      }

      .toast {
        animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      textarea:focus,
      input:focus {
        outline: none;
        ring: 2px;
        ring-color: #667eea;
      }
    </style>
  </head>
  <body class="min-h-screen gradient-bg">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Loading Screen -->
    <div
      id="loading-screen"
      class="fixed inset-0 gradient-bg flex items-center justify-center z-40"
    >
      <div class="text-center text-white">
        <i class="fas fa-lock text-5xl mb-4"></i>
        <div class="spinner mx-auto"></div>
      </div>
    </div>

    <!-- Auth Screen -->
    <div
      id="auth-screen"
      class="hidden min-h-screen flex items-center justify-center p-4"
    >
      <div
        class="glass-card rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in"
      >
        <div class="text-center mb-8">
          <i class="fas fa-lock text-4xl text-purple-600 mb-3"></i>
          <h1 class="text-2xl font-bold text-gray-800">Private Notes Vault</h1>
          <p class="text-gray-500 mt-2">Your secure personal notes</p>
        </div>

        <!-- Auth Tabs -->
        <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
          <button
            id="login-tab"
            onclick="switchAuthTab('login')"
            class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all bg-white shadow text-purple-600"
          >
            Login
          </button>
          <button
            id="signup-tab"
            onclick="switchAuthTab('signup')"
            class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all text-gray-500"
          >
            Sign Up
          </button>
        </div>

        <!-- Auth Form -->
        <form id="auth-form" onsubmit="handleAuth(event)" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Email</label
            >
            <input
              type="email"
              id="auth-email"
              required
              class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all"
              placeholder="you@example.com"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Password</label
            >
            <input
              type="password"
              id="auth-password"
              required
              minlength="6"
              class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all"
              placeholder="••••••••"
            />
          </div>
          <button
            type="submit"
            id="auth-submit"
            class="w-full py-3 px-4 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-all flex items-center justify-center gap-2"
          >
            <span id="auth-btn-text">Login</span>
            <div id="auth-spinner" class="spinner hidden"></div>
          </button>
        </form>

        <div class="relative my-6">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-200"></div>
          </div>
          <div class="relative flex justify-center text-sm">
            <span class="px-2 bg-white text-gray-500">or</span>
          </div>
        </div>

        <!-- Google OAuth -->
        <button
          onclick="signInWithGoogle()"
          class="w-full py-3 px-4 bg-white hover:bg-gray-50 border border-gray-200 text-gray-700 font-medium rounded-lg transition-all flex items-center justify-center gap-3"
        >
          <svg class="w-5 h-5" viewBox="0 0 24 24">
            <path
              fill="#4285F4"
              d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
            />
            <path
              fill="#34A853"
              d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
            />
            <path
              fill="#FBBC05"
              d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
            />
            <path
              fill="#EA4335"
              d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
            />
          </svg>
          Continue with Google
        </button>

        <p
          id="auth-error"
          class="mt-4 text-center text-red-500 text-sm hidden"
        ></p>
      </div>
    </div>

    <!-- Notes List Screen -->
    <div id="notes-screen" class="hidden min-h-screen">
      <header class="bg-white/90 backdrop-blur-sm shadow-sm sticky top-0 z-10">
        <div
          class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between"
        >
          <div class="flex items-center gap-3">
            <i class="fas fa-lock text-purple-600 text-xl"></i>
            <h1 class="text-xl font-bold text-gray-800">Private Notes</h1>
          </div>
          <div class="flex items-center gap-4">
            <span
              id="user-email"
              class="text-sm text-gray-500 hidden sm:block"
            ></span>
            <button
              onclick="logout()"
              class="text-gray-500 hover:text-red-500 transition-colors"
            >
              <i class="fas fa-sign-out-alt"></i>
              <span class="ml-1 hidden sm:inline">Logout</span>
            </button>
          </div>
        </div>
      </header>

      <main class="max-w-4xl mx-auto px-4 py-6 fade-in">
        <button
          onclick="showEditor()"
          class="w-full mb-6 py-4 px-6 bg-white hover:bg-gray-50 rounded-xl shadow-lg border-2 border-dashed border-purple-200 hover:border-purple-400 transition-all flex items-center justify-center gap-2 text-purple-600 font-medium"
        >
          <i class="fas fa-plus"></i>
          New Note
        </button>

        <div id="notes-list" class="space-y-4">
          <!-- Notes will be rendered here -->
        </div>

        <div id="empty-state" class="hidden text-center py-16">
          <i class="fas fa-sticky-note text-6xl text-purple-200 mb-4"></i>
          <h3 class="text-xl font-medium text-gray-600 mb-2">No notes yet</h3>
          <p class="text-gray-400">Create your first private note</p>
        </div>

        <div id="notes-loading" class="hidden text-center py-16">
          <div
            class="spinner mx-auto border-purple-600 border-t-transparent"
          ></div>
          <p class="text-gray-500 mt-4">Loading your notes...</p>
        </div>
      </main>
    </div>

    <!-- Note Editor Screen -->
    <div id="editor-screen" class="hidden min-h-screen">
      <header class="bg-white/90 backdrop-blur-sm shadow-sm sticky top-0 z-10">
        <div
          class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between"
        >
          <button
            onclick="showNotes()"
            class="flex items-center gap-2 text-gray-600 hover:text-gray-800 transition-colors"
          >
            <i class="fas fa-arrow-left"></i>
            <span>Back</span>
          </button>
          <div class="flex items-center gap-3">
            <span
              id="auto-save-indicator"
              class="text-xs text-green-500 hidden"
            >
              <i class="fas fa-check"></i> Saved
            </span>
          </div>
        </div>
      </header>

      <main class="max-w-4xl mx-auto px-4 py-6 fade-in">
        <div class="glass-card rounded-xl shadow-lg p-6">
          <input
            type="text"
            id="note-title"
            placeholder="Note title..."
            class="w-full text-2xl font-bold text-gray-800 border-none bg-transparent mb-4 placeholder-gray-300"
            oninput="handleAutoSave()"
          />
          <textarea
            id="note-content"
            placeholder="Start writing..."
            rows="12"
            class="w-full text-gray-600 border-none bg-transparent resize-none placeholder-gray-300"
            oninput="handleAutoSave()"
          ></textarea>
        </div>

        <div class="flex gap-3 mt-6">
          <button
            onclick="saveNote()"
            id="save-btn"
            class="flex-1 py-3 px-6 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-all flex items-center justify-center gap-2"
          >
            <i class="fas fa-save"></i>
            Save Note
          </button>
          <button
            onclick="deleteNote()"
            id="delete-btn"
            class="hidden py-3 px-6 bg-red-100 hover:bg-red-200 text-red-600 font-medium rounded-lg transition-all flex items-center justify-center gap-2"
          >
            <i class="fas fa-trash"></i>
            Delete
          </button>
        </div>
      </main>
    </div>

    <!-- View Note Screen -->
    <div id="view-screen" class="hidden min-h-screen">
      <header class="bg-white/90 backdrop-blur-sm shadow-sm sticky top-0 z-10">
        <div
          class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between"
        >
          <button
            onclick="showNotes()"
            class="flex items-center gap-2 text-gray-600 hover:text-gray-800 transition-colors"
          >
            <i class="fas fa-arrow-left"></i>
            <span>Back</span>
          </button>
          <div class="flex items-center gap-3">
            <button
              onclick="editCurrentNote()"
              class="text-purple-600 hover:text-purple-700 transition-colors"
            >
              <i class="fas fa-edit"></i>
              <span class="ml-1">Edit</span>
            </button>
            <button
              onclick="deleteNote()"
              class="text-red-500 hover:text-red-600 transition-colors"
            >
              <i class="fas fa-trash"></i>
              <span class="ml-1">Delete</span>
            </button>
          </div>
        </div>
      </header>

      <main class="max-w-4xl mx-auto px-4 py-6 fade-in">
        <div class="glass-card rounded-xl shadow-lg p-6">
          <h1
            id="view-title"
            class="text-2xl font-bold text-gray-800 mb-2"
          ></h1>
          <p id="view-timestamp" class="text-sm text-gray-400 mb-6"></p>
          <div
            id="view-content"
            class="text-gray-600 whitespace-pre-wrap"
          ></div>
        </div>
      </main>
    </div>

    <script>
      // ===== CONFIGURATION =====
      let supabase;
      let currentUser = null;
      let currentNote = null;
      let authMode = "login";
      let autoSaveTimeout = null;

      // Initialize app
      async function init() {
        try {
          // Get Supabase config from meta tags or use defaults
          const supabaseUrl =
            window.SUPABASE_URL || "https://yrzoxzxxnmkasisvqzld.supabase.co";
          const supabaseKey =
            window.SUPABASE_ANON_KEY ||
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlyem94enh4bm1rYXNpc3ZxemxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5ODMyNDcsImV4cCI6MjA4MzU1OTI0N30.RxZ72j61ABJXxkQibggBjOCs76IaH2yZkeVktZqZqeo";

          supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

          // Check for OAuth callback
          const {
            data: { session },
            error,
          } = await supabase.auth.getSession();

          if (session) {
            currentUser = session.user;
            showNotesScreen();
          } else {
            showAuthScreen();
          }

          // Listen for auth changes
          supabase.auth.onAuthStateChange((event, session) => {
            if (event === "SIGNED_IN" && session) {
              currentUser = session.user;
              showNotesScreen();
            } else if (event === "SIGNED_OUT") {
              currentUser = null;
              showAuthScreen();
            }
          });
        } catch (err) {
          console.error("Init error:", err);
          showToast("Failed to initialize app", "error");
          showAuthScreen();
        }
      }

      // ===== AUTH FUNCTIONS =====
      function switchAuthTab(mode) {
        authMode = mode;
        const loginTab = document.getElementById("login-tab");
        const signupTab = document.getElementById("signup-tab");
        const btnText = document.getElementById("auth-btn-text");

        if (mode === "login") {
          loginTab.classList.add("bg-white", "shadow", "text-purple-600");
          loginTab.classList.remove("text-gray-500");
          signupTab.classList.remove("bg-white", "shadow", "text-purple-600");
          signupTab.classList.add("text-gray-500");
          btnText.textContent = "Login";
        } else {
          signupTab.classList.add("bg-white", "shadow", "text-purple-600");
          signupTab.classList.remove("text-gray-500");
          loginTab.classList.remove("bg-white", "shadow", "text-purple-600");
          loginTab.classList.add("text-gray-500");
          btnText.textContent = "Sign Up";
        }
      }

      async function handleAuth(e) {
        e.preventDefault();
        const email = document.getElementById("auth-email").value;
        const password = document.getElementById("auth-password").value;
        const spinner = document.getElementById("auth-spinner");
        const btnText = document.getElementById("auth-btn-text");
        const errorEl = document.getElementById("auth-error");

        spinner.classList.remove("hidden");
        btnText.classList.add("hidden");
        errorEl.classList.add("hidden");

        try {
          let result;
          if (authMode === "login") {
            result = await supabase.auth.signInWithPassword({
              email,
              password,
            });
          } else {
            result = await supabase.auth.signUp({ email, password });
          }

          if (result.error) {
            throw result.error;
          }

          if (
            authMode === "signup" &&
            result.data.user &&
            !result.data.session
          ) {
            showToast("Check your email to confirm your account", "success");
          }
        } catch (err) {
          errorEl.textContent = err.message || "Authentication failed";
          errorEl.classList.remove("hidden");
        } finally {
          spinner.classList.add("hidden");
          btnText.classList.remove("hidden");
        }
      }

      async function signInWithGoogle() {
        try {
          const { error } = await supabase.auth.signInWithOAuth({
            provider: "google",
            options: {
              redirectTo: window.location.origin,
            },
          });
          if (error) throw error;
        } catch (err) {
          showToast(err.message || "Google sign in failed", "error");
        }
      }

      async function logout() {
        try {
          await supabase.auth.signOut();
          currentUser = null;
          showAuthScreen();
          showToast("Logged out successfully", "success");
        } catch (err) {
          showToast("Logout failed", "error");
        }
      }

      // ===== SCREEN NAVIGATION =====
      function hideAllScreens() {
        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("auth-screen").classList.add("hidden");
        document.getElementById("notes-screen").classList.add("hidden");
        document.getElementById("editor-screen").classList.add("hidden");
        document.getElementById("view-screen").classList.add("hidden");
      }

      function showAuthScreen() {
        hideAllScreens();
        document.getElementById("auth-screen").classList.remove("hidden");
      }

      function showNotesScreen() {
        hideAllScreens();
        document.getElementById("notes-screen").classList.remove("hidden");
        document.getElementById("user-email").textContent =
          currentUser?.email || "";
        loadNotes();
      }

      function showEditor(note = null) {
        hideAllScreens();
        currentNote = note;
        document.getElementById("editor-screen").classList.remove("hidden");
        document.getElementById("note-title").value = note?.title || "";
        document.getElementById("note-content").value = note?.content || "";
        document.getElementById("delete-btn").classList.toggle("hidden", !note);
        document.getElementById("auto-save-indicator").classList.add("hidden");
      }

      function showViewScreen(note) {
        hideAllScreens();
        currentNote = note;
        document.getElementById("view-screen").classList.remove("hidden");
        document.getElementById("view-title").textContent = note.title;
        document.getElementById("view-timestamp").textContent =
          formatRelativeTime(note.created_at);
        document.getElementById("view-content").textContent = note.content;
      }

      // ===== NOTES FUNCTIONS =====
      async function loadNotes() {
        const listEl = document.getElementById("notes-list");
        const emptyEl = document.getElementById("empty-state");
        const loadingEl = document.getElementById("notes-loading");

        listEl.innerHTML = "";
        emptyEl.classList.add("hidden");
        loadingEl.classList.remove("hidden");

        try {
          const token = (await supabase.auth.getSession()).data.session
            ?.access_token;
          const res = await fetch("/api/notes", {
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await res.json();

          loadingEl.classList.add("hidden");

          if (!data.notes || data.notes.length === 0) {
            emptyEl.classList.remove("hidden");
            return;
          }

          data.notes.forEach((note) => {
            const card = createNoteCard(note);
            listEl.appendChild(card);
          });
        } catch (err) {
          loadingEl.classList.add("hidden");
          showToast("Failed to load notes", "error");
        }
      }

      function createNoteCard(note) {
        const div = document.createElement("div");
        div.className =
          "glass-card rounded-xl shadow-lg p-5 cursor-pointer note-card transition-all duration-200";
        div.onclick = () => showViewScreen(note);

        const preview =
          note.content.length > 100
            ? note.content.substring(0, 100) + "..."
            : note.content;

        div.innerHTML = `
        <h3 class="font-bold text-gray-800 mb-1">${escapeHtml(note.title)}</h3>
        <p class="text-xs text-gray-400 mb-2">${formatRelativeTime(
          note.created_at
        )}</p>
        <p class="text-gray-500 text-sm">${escapeHtml(preview)}</p>
      `;

        return div;
      }

      async function saveNote() {
        const title = document.getElementById("note-title").value.trim();
        const content = document.getElementById("note-content").value.trim();

        if (!title) {
          showToast("Please enter a title", "error");
          return;
        }

        try {
          const token = (await supabase.auth.getSession()).data.session
            ?.access_token;
          const method = currentNote ? "PUT" : "POST";
          const url = currentNote
            ? `/api/notes/${currentNote.id}`
            : "/api/notes";

          const res = await fetch(url, {
            method,
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ title, content }),
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || "Failed to save note");
          }

          const data = await res.json();
          currentNote = data.note;

          showToast("Note saved!", "success");
          showNotesScreen();
        } catch (err) {
          showToast(err.message || "Failed to save note", "error");
        }
      }

      async function deleteNote() {
        if (!currentNote) return;

        if (!confirm("Are you sure you want to delete this note?")) return;

        try {
          const token = (await supabase.auth.getSession()).data.session
            ?.access_token;
          const res = await fetch(`/api/notes/${currentNote.id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!res.ok) throw new Error("Failed to delete");

          showToast("Note deleted", "success");
          showNotesScreen();
        } catch (err) {
          showToast("Failed to delete note", "error");
        }
      }

      function editCurrentNote() {
        if (currentNote) {
          showEditor(currentNote);
        }
      }

      // Auto-save functionality
      function handleAutoSave() {
        if (!currentNote) return;

        clearTimeout(autoSaveTimeout);
        document.getElementById("auto-save-indicator").classList.add("hidden");

        autoSaveTimeout = setTimeout(async () => {
          const title = document.getElementById("note-title").value.trim();
          const content = document.getElementById("note-content").value.trim();

          if (!title) return;

          try {
            const token = (await supabase.auth.getSession()).data.session
              ?.access_token;
            await fetch(`/api/notes/${currentNote.id}`, {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ title, content }),
            });

            document
              .getElementById("auto-save-indicator")
              .classList.remove("hidden");
          } catch (err) {
            console.error("Auto-save failed:", err);
          }
        }, 2000);
      }

      // ===== UTILITIES =====
      function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");

        const bgColor =
          type === "success"
            ? "bg-green-500"
            : type === "error"
            ? "bg-red-500"
            : "bg-purple-500";

        toast.className = `toast px-4 py-3 rounded-lg shadow-lg text-white ${bgColor} flex items-center gap-2`;
        toast.innerHTML = `
        <i class="fas ${
          type === "success"
            ? "fa-check-circle"
            : type === "error"
            ? "fa-exclamation-circle"
            : "fa-info-circle"
        }"></i>
        ${escapeHtml(message)}
      `;

        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      function formatRelativeTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) return "Just now";
        if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;

        return date.toLocaleDateString();
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Initialize on load
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
